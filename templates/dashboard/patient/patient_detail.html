{% extends 'partials/base.html' %}
{% load static %}

{% block extracss %}
    <link rel="stylesheet" href="{% static 'css/dashboard/patient.css' %}">
{% endblock %}

{% block title %} Hồ Sơ: {{ patient.full_name }} {% endblock %}


{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4><i class="fas fa-user-injured mr-2"></i>Hồ Sơ Bệnh Nhân</h4>
            <div>
                <a href="{% url 'dashboard-patient-list' %}" class="btn btn-light btn-sm"><i class="fas fa-arrow-left mr-1"></i> Danh sách Bệnh Nhân</a>
                <a href="{% url 'dashboard-patient-update' patient.id %}" class="btn btn-warning btn-sm"><i class="fas fa-edit mr-1"></i> Chỉnh Sửa</a>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 text-center">
                    <div class="patient-avatar-frame">
                        <img src="{% if patient.avatar %}{{ patient.avatar.url }}{% else %}{% static 'images/default_image.jpg' %}{% endif %}" alt="Avatar">
                    </div>

                    <h4 class="font-weight-bold">{{ patient.full_name }}</h4>
                    <p class="text-muted">{{ patient.age }} tuổi - {{ patient.gender }}</p>
                </div>
                <div class="col-md-9">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Thông tin cá nhân</h5><hr class="mt-1">
                            <p><strong>Ngày sinh:</strong> {{ patient.date_of_birth|date:"d/m/Y"|default:"Chưa có" }}</p>
                            <p><strong>SĐT:</strong> {{ patient.phone_number|default:"Chưa có" }}</p>
                            <p><strong>Địa chỉ:</strong> {{ patient.address|default:"Chưa có" }}</p>
                            <p><strong>Dân tộc:</strong> {{ patient.ethnicity|default:"Chưa có" }}</p>
                        </div>
                        <div class="col-md-6">
                            <h5>Thông tin định danh</h5><hr class="mt-1">
                            <p><strong>Số CCCD:</strong> {{ patient.citizen_id|default:"Chưa có" }}</p>
                            <p><strong>Số BHYT:</strong> {{ patient.health_insurance_id|default:"Chưa có" }}</p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h5>Thông tin y tế</h5><hr class="mt-1">
                            <p><strong>Nhóm máu:</strong> <span class="badge badge-danger p-2">{{ patient.blood_type }}</span></p>
                            <p><strong>Dị ứng:</strong> {{ patient.allergies|linebreaksbr|default:"Không có" }}</p>
                            <p><strong>Bệnh sử:</strong> {{ patient.medical_history|linebreaksbr|default:"Không có" }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Card Lịch Sử Kê Đơn -->
    <div class="card shadow-sm mt-4">
        <div class="card-header">
            <h5><i class="fas fa-history mr-2"></i>Lịch Sử Kê Đơn</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="thead-light"><tr><th>ID Toa</th><th>Bác Sĩ</th><th>Ngày Kê</th><th>Trạng Thái</th></tr></thead>
                    <tbody>
                        {% for p in prescriptions %}
                        <tr>
                            <td>{{ p.id }}</td><td>{{ p.doctor.username }}</td><td>{{ p.created_at|date:"d/m/Y H:i" }}</td>
                            <td>
                                {% if p.status == 'Dispensed' %}<span class="badge badge-success">Đã lấy thuốc</span>
                                {% elif p.status == 'Pending' %}<span class="badge badge-warning">Chờ lấy thuốc</span>
                                {% else %}<span class="badge badge-secondary">{{ p.get_status_display }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="4" class="text-center">Bệnh nhân chưa có lịch sử kê đơn.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}